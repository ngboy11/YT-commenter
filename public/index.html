<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YouTube Commenter App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: radial-gradient(circle at top left, #111827, #0f172a);
      color: #f9fafb;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }
    .glass {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .fade-in {
      animation: fadeIn 0.8s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center p-6">
  <div class="max-w-xl w-full glass rounded-2xl p-6 shadow-2xl fade-in">
    <h1 class="text-3xl font-bold text-center mb-6 text-red-400">üé• YouTube Commenter</h1>

    <!-- Auth Section -->
    <div id="auth-area" class="text-center mb-6">
      <button id="btn-auth" class="hidden bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold">Sign in with Google</button>
      <button id="btn-signout" class="hidden bg-gray-700 hover:bg-gray-800 text-white px-5 py-2 rounded-lg font-semibold">Sign out</button>
      <p id="auth-status" class="text-gray-400 mt-2 text-sm">Checking authentication...</p>
    </div>

    <!-- Input Section -->
    <div>
      <label class="block font-semibold mb-1">YouTube Video Link or ID</label>
      <input id="video-link" class="w-full p-2 rounded-md bg-gray-900 border border-gray-700 text-gray-200 mb-4" placeholder="https://youtu.be/VIDEO_ID or ID">

      <label class="block font-semibold mb-1">Comment Template</label>
      <textarea id="comment-text" rows="3" class="w-full p-2 rounded-md bg-gray-900 border border-gray-700 text-gray-200 mb-4" placeholder="Awesome video! {{keyword}}"></textarea>

      <div class="grid grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block font-semibold mb-1">Keyword</label>
          <input id="keyword" class="w-full p-2 rounded-md bg-gray-900 border border-gray-700 text-gray-200" placeholder="keyword"/>
        </div>
        <div>
          <label class="block font-semibold mb-1">Repeat</label>
          <input id="repeat" type="number" value="1" min="1" class="w-full p-2 rounded-md bg-gray-900 border border-gray-700 text-gray-200"/>
        </div>
        <div>
          <label class="block font-semibold mb-1">Interval (sec)</label>
          <input id="interval" type="number" value="5" min="1" class="w-full p-2 rounded-md bg-gray-900 border border-gray-700 text-gray-200"/>
        </div>
      </div>
    </div>

    <!-- Control Buttons -->
    <div class="flex gap-3 justify-center mb-4">
      <button id="btn-start" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold">‚ñ∂ Start</button>
      <button id="btn-stop" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-semibold" disabled>‚è∏ Stop</button>
    </div>

    <!-- Log Area -->
    <div>
      <h3 class="text-lg font-semibold mb-2 text-gray-300">üßæ Activity Log</h3>
      <div id="log" class="w-full h-40 overflow-y-auto bg-gray-900 rounded-md border border-gray-800 p-3 text-sm text-gray-300"></div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
(async function(){
  const el = id => document.getElementById(id);
  const logEl = el('log');
  const log = (...args) => {
    const time = new Date().toLocaleTimeString();
    logEl.innerHTML += `<div>[${time}] ${args.join(' ')}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
  };

  async function getAuthUrl() {
    const r = await fetch('/auth/url');
    return await r.json();
  }

  async function checkAuth() {
    const r = await fetch('/api/auth/status');
    const j = await r.json();
    if (j.authed) {
      el('btn-auth').classList.add('hidden');
      el('btn-signout').classList.remove('hidden');
      el('auth-status').innerText = '‚úÖ Signed in';
      el('auth-status').classList.replace('text-gray-400', 'text-green-400');
    } else {
      el('btn-auth').classList.remove('hidden');
      el('btn-signout').classList.add('hidden');
      el('auth-status').innerText = '‚ùå Not signed in';
      el('auth-status').classList.replace('text-green-400', 'text-gray-400');
    }
  }

  el('btn-auth').addEventListener('click', async () => {
    const { url } = await getAuthUrl();
    window.location = url;
  });

  el('btn-signout').addEventListener('click', async () => {
    await fetch('/api/auth/signout', { method:'POST' });
    await checkAuth();
    log('Signed out.');
  });

  async function parseVideoId(url){
    const r = await fetch('/api/parse-video-id?url=' + encodeURIComponent(url));
    const j = await r.json();
    return j.videoId;
  }

  let stopRequested = false;
  el('btn-start').addEventListener('click', async () => {
    stopRequested = false;
    el('btn-start').disabled = true;
    el('btn-stop').disabled = false;
    log('üöÄ Starting...');
    const rawLink = el('video-link').value.trim();
    const videoId = await parseVideoId(rawLink) || rawLink;
    if (!videoId) {
      log('‚ö†Ô∏è Invalid YouTube link.');
      el('btn-start').disabled = false;
      el('btn-stop').disabled = true;
      return;
    }

    const repeat = Math.max(1, parseInt(el('repeat').value || '1', 10));
    const intervalSec = Math.max(1, parseInt(el('interval').value || '5', 10));
    const template = el('comment-text').value || '';
    const keyword = el('keyword').value || '';

    for (let i = 0; i < repeat; i++) {
      if (stopRequested) { log('üõë Stopped by user.'); break; }
      const text = template.replace(/\{\{keyword\}\}/g, keyword);
      log(`üí¨ Posting ${i+1}/${repeat}: "${text}"`);
      try {
        const r = await fetch('/api/post-comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId, text })
        });
        const j = await r.json();
        if (r.ok) {
          log('‚úÖ Comment posted!');
        } else {
          log('‚ö†Ô∏è Error: ' + (j.error || JSON.stringify(j)));
          if (r.status === 401) {
            log('üîí Not authenticated. Please sign in again.');
            break;
          }
        }
      } catch (err) {
        log('‚ùå Network error: ' + err.message);
        break;
      }
      if (i < repeat - 1) {
        log(`‚è≥ Waiting ${intervalSec}s before next...`);
        const stopAt = Date.now() + intervalSec*1000;
        while (Date.now() < stopAt) {
          if (stopRequested) break;
          await new Promise(r => setTimeout(r, 250));
        }
      }
    }

    el('btn-start').disabled = false;
    el('btn-stop').disabled = true;
    log('üèÅ Finished.');
  });

  el('btn-stop').addEventListener('click', () => {
    stopRequested = true;
    el('btn-stop').disabled = true;
  });

  await checkAuth();
})();
  </script>
</body>
</html>
